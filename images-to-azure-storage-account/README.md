*Copyright (C) 2021, Axis Communications AB, Lund, Sweden. All Rights Reserved.*

# Images to Azure storage account <!-- omit in toc -->

[![Build images-to-azure-storage-account](https://github.com/AxisCommunications/acap-integration-examples-azure/actions/workflows/images-to-azure-storage-account.yml/badge.svg)](https://github.com/AxisCommunications/acap-integration-examples-azure/actions/workflows/images-to-azure-storage-account.yml)

## Table of contents <!-- omit in toc -->

- [Overview](#overview)
- [Prerequisites](#prerequisites)
- [File structure](#file-structure)
- [Instructions](#instructions)
- [Cleanup](#cleanup)
- [Troubleshooting](#troubleshooting)
- [License](#license)

## Overview

In this example we create an application that sends images from an Axis camera to an Azure storage account.

![architecture](./assets/architecture.png)

This application consists of the following Azure resources.

- An API Management instance
- A storage account with a blob container

The camera will send images to the blob container via an API Management endpoint. The API Management resource receives a POST request containing the image from the camera. This request is transformed to a PUT request as this is required by the Azure storage REST API. The API Management uses a system-assigned managed identity to authenticate to Azure storage. The API Management endpoint is secured by a subscription key which is provided to the camera.

## Prerequisites

- A network camera from Axis Communications (example has been verified to work on a camera with firmware version >=9.80.3.1)
- Azure CLI ([install](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli))
- Azure Bicep CLI (install with `az bicep install`)

## File structure

```
images-to-azure-storage-account
├── main.bicep - Azure Bicep template describing the Azure resources
├── policy-get.xml - Azure API Management policy document
└── policy-post.xml - Azure API Management policy document
```

## Instructions

The instructions are divided into two parts. The first part covers deploying the Azure resources and the second part covers configuring the camera.

To start off, make sure to clone the repository and navigate into the example directory.

```
git clone https://github.com/AxisCommunications/acap-integration-examples-azure.git
cd acap-integration-examples-azure/images-to-azure-storage-account
```

### Deploy Azure resources

Let's deploy the Azure resources receiving the images sent from a camera. The services are described in `main.bicep` using an [Azure Bicep template](https://docs.microsoft.com/azure/azure-resource-manager/bicep/). To keep all resources in Azure grouped together we start by creating a new resource group. To create a new resource group named `MyResourceGroup` in the `eastus` Azure region run the following command in your shell.

```
az group create -n MyResourceGroup -l eastus
```

Next we want to deploy the Bicep template to our resource group.

```
az deployment group create -g MyResourceGroup -f main.bicep -p publisherEmail=<e-mail address> --query '{Endpoint: properties.outputs.endpoint.value}' -o table
```

Replace `<e-mail address>` with a valid e-mail address. The e-mail address you provide will receive all system notifications sent from the API-management resource that is created. The output from the deployment command is the endpoint we will use in the next chapter when we configure the camera.

### Configure the camera

Now that the resources in Azure are ready to accept images, let's continue with configuring the camera to send them.

Navigate to the camera using your preferred web browser. In the user interface of the camera, select *Settings* -> *System* -> *Events* -> *Device events*. In this user interface we'll do all configuration, but first let's get an overview of the available tabs.

- **Rules** - Here we'll create a rule that sends images to our Azure storage account
- **Schedules** - In this sample we'll use a schedule to define *when* a snapshot should be sent. If a schedule doesn't fit your specific use case, you can replace it with any event generated on the camera or even events generated by ACAPs installed on the camera.
- **Recipients** - Here we'll define *where* images are sent

Let's start with *Recipients*. Select the tab and create a new recipient with the following settings.

- **Name**: `Azure storage`
- **Type**: `HTTPS`
- **URL**: Specify the endpoint you obtained in the first part of this tutorial, for example: `https://image-upload-abcdefghijklm.azure-api.net?accessToken=abcdef1234567890abcdef1234567890`.

Click the *Save* button.

Now let's navigate to the *Schedules* tab. In this sample we'll use a schedule to define when a snapshot should be send. Create a new schedule with the following settings.

- **Type**: `Pulse`
- **Name**: `Every minute`
- **Repeat every**: `1 Minute`

Click the *Save* button.

Now let's navigate to the *Rules* tab. Here we'll finally create a rule that combines the recipient and the schedule into a rule. Create a new rule with the following settings.

- **Name**: `Images to Azure storage`
- **Condition**: `Pulse`
  - **Pulse**: `Every Minute`
- **Action**: `Send images through HTTPS`
  - **Recipient**: `Azure storage`
  - **Maximum images**: `1`

Click the *Save* button.

At this point the rule will become active and send a snapshot to Azure storage every minute.

## Cleanup

To delete the deployed Azure services, including all images in the storage account, either use the Azure portal to delete the resource group, or run the following CLI command.

```
az group delete --name <resource group name>
```

## Troubleshooting

This section will highlight some of the common problems one might encounter when running this example application.

### No images are sent to the Azure storage account

If the camera is unable to successfully send images to the Azure storage account, please make sure that the following statements are true.

- **The camera is not behind a proxy**. This example does not support a network topology where requests needs to traverse a proxy to reach the internet.

### ICU package error when running this example on Ubuntu

Running this example on Ubuntu could result in the following error.

```
ERROR: Process terminated. Couldn't find a valid ICU package installed on the system. Set the configuration flag System.Globalization.Invariant to true if you want to run with no globalization support.
```

This can be solved by setting an environment variable.

```bash
export DOTNET_SYSTEM_GLOBALIZATION_INVARIANT=1
```

## License

[Apache 2.0](./LICENSE)
